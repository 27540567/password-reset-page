<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Your Password</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 50px; }
        .container { max-width: 400px; margin: auto; border: 1px solid #ccc; padding: 30px; border-radius: 10px; }
        input, button { width: 100%; padding: 10px; margin: 10px 0; box-sizing: border-box; }
        #message { margin-top: 20px; padding: 10px; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Set New Password</h2>
        <p>Please enter your new password below.</p>
        <input type="password" id="newPassword" placeholder="New Password">
        <input type="password" id="confirmPassword" placeholder="Confirm Password">
        <button onclick="resetPassword()">Reset Password</button>
        <div id="message"></div>
    </div>

    <script>
        // !!! 重要：请替换为你自己的项目信息 !!!
        const SUPABASE_URL = 'https://yemnnhaiuotepsuekyma.supabase.co'; // 你的Supabase URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InllbW5uaGFpdW90ZXBzdWVreW1hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzMTk5NzEsImV4cCI6MjA4MDg5NTk3MX0.vYlO3xyLgchlQntZij4MBDx0U0BB8jCp9gGLdjn0CaQ'; // 你的 anon/public key

        // 初始化 Supabase 客户端
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

async function resetPassword() {
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const messageDiv = document.getElementById('message');

    // 清空之前的信息
    messageDiv.textContent = '';
    messageDiv.className = '';

    // 1. 验证密码是否一致
    if (newPassword !== confirmPassword) {
        messageDiv.textContent = 'Passwords do not match!';
        messageDiv.className = 'error';
        return;
    }

    // ====== 【核心修改开始】处理 PKCE 流程 ======
    let accessToken = null;
    let refreshToken = null;

    // 2. 首先检查 URL 中是否有授权码 (code)
    const urlParams = new URLSearchParams(window.location.search);
    const authCode = urlParams.get('code');

    if (authCode) {
        // 情况A：有 code，需要执行 PKCE 交换
        try {
            const { data: exchangeData, error: exchangeError } = await supabaseClient.auth.exchangeCodeForSession(authCode);
            if (exchangeError) throw exchangeError;
            // 交换成功，从返回的数据中获取令牌
            accessToken = exchangeData.session.access_token;
            refreshToken = exchangeData.session.refresh_token;
            console.log('PKCE交换成功，获得令牌');
        } catch (exchangeErr) {
            console.error('PKCE交换失败:', exchangeErr);
            messageDiv.textContent = 'Failed to verify link: ' + exchangeErr.message;
            messageDiv.className = 'error';
            return;
        }
    } else {
        // 情况B：没有 code，回退到旧逻辑，检查哈希中的令牌 (非PKCE流程或备用)
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        accessToken = hashParams.get('access_token');
        refreshToken = hashParams.get('refresh_token');
    }

    // 3. 判断是否成功获得了令牌
    if (!accessToken) {
        messageDiv.textContent = 'Invalid or expired reset link. Please request a new one.';
        messageDiv.className = 'error';
        return;
    }
    // ====== 【核心修改结束】 ======

    // 4. 设置 Session，然后更新密码 (后面的代码保持不变)
    try {
        const { data: sessionData, error: sessionError } = await supabaseClient.auth.setSession({
            access_token: accessToken,
            refresh_token: refreshToken
        });
        if (sessionError) throw sessionError;

        const { data, error } = await supabaseClient.auth.updateUser({
            password: newPassword
        });
        if (error) throw error;

        messageDiv.textContent = 'Password updated successfully! You can now close this page and log in with your new password.';
        messageDiv.className = 'success';

    } catch (error) {
        console.error('Password reset error:', error);
        messageDiv.textContent = 'Failed to reset password: ' + error.message;
        messageDiv.className = 'error';
    }
};
    </script>
</body>
</html>
